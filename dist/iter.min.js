/*! iter 2015-03-10 */
!function(global){"use strict";var isArray=function(value){return value&&Array.isArray(value)},isString=function(value){return"string"==typeof value},isFunction=function(value){return value&&"function"==typeof value},isObject=function(value){return value&&"object"==typeof value},bindContext=function(func,$this){return void 0===$this?func:func.bind($this)},toArray=function(args){return Array.prototype.slice.call(args)},ASCII_JS_IDENTIFIER_REGEX=/^[$a-z_][$a-z0-9_]*$/i,isJSIdentifier=function(value){return value&&isString(value)&&ASCII_JS_IDENTIFIER_REGEX.test(value)},QUICK_RESULT={BOOL:"bool",VOID:"void",ANY:"any"},quickToFunction=function(expression,options){try{options=options||{};var body,parameters=options.parameters||["$","$index"];switch(options.result){case QUICK_RESULT.BOOL:body="return Boolean("+expression+");";break;case QUICK_RESULT.VOID:body=expression+"; return;";break;default:body="return ("+expression+");"}return Function.apply(null,parameters.concat([body]))}catch(ex){var error=new Error('Attempt to create function from expression "'+expression+'" failed. See $details property for original exception.');throw error.$details=ex,error}},isPropertySelector=function(value){return void 0!==value},createPropertySelectorFunction=function(propertyName){return function($){return $[propertyName]}},isPropertyMultiselector=function(obj){if(!isArray(obj))return!1;for(var i=0;i<obj.length;i+=1)if(!isPropertySelector(obj[i]))return!1;return!0},createPropertyMultiselectorFunciton=function(propertyNames){return function($){for(var result={},i=0;i<propertyNames.length;i+=1)result[propertyNames[i]]=$[propertyNames[i]];return result}},isQuick=function(value){return value&&isString(value)},throwIfNotQuickOrFunction=function(argValue,argName,funcName){if(!argValue||!isString(argValue)&&!isFunction(argValue))throw new Error("Invalid value of iter."+funcName+"() argument "+argName+". Valid values are quick expressions and functions")},extend=function(){for(var args=toArray(arguments),result={},i=0;i<args.length;i+=1){var ithObject=args[i];for(var prop in ithObject)Object.prototype.hasOwnProperty.call(ithObject,prop)&&(result[prop]=ithObject[prop])}return result},ArrayIterator=function($array){this.$$index=-1,this.$$array=$array};ArrayIterator.prototype.next=function(){var incIndex=this.$$index+1;return incIndex<this.$$array.length?(this.$$index=incIndex,!0):!1},ArrayIterator.prototype.current=function(){if(-1===this.$$index)throw new Error("Call next() before current().");return this.$$array[this.$$index]};var ObjectIterator=function($object){this.$$index=-1,this.$$keys=Object.keys($object),this.$$object=$object};ObjectIterator.prototype.next=function(){for(var i=this.$$index+1,keys=this.$$keys,obj=this.$$object;i<keys.length;){if(Object.prototype.hasOwnProperty.call(obj,keys[i])){this.$$index=i;break}i+=1}return i<keys.length},ObjectIterator.prototype.current=function(){if(-1===this.$$index)throw new Error("call next() before current()");var key=this.$$keys[this.$$index],value=this.$$object[key];return{key:key,value:value}};var FunctionIterator=function($func){this.$$func=$func};FunctionIterator.prototype.next=function(){try{var newCurrent=this.$$func();return void 0!==newCurrent?(this.$$current=newCurrent,!0):!1}catch(ex){var error=new Error("Function thrown exception ($details property contains original exception).");throw error.$details=ex,error}},FunctionIterator.prototype.current=function(){if(void 0===this.$$current)throw new Error("Call next() before current().");return this.$$current};var Iterable=function(iteratorFunction){if(!iteratorFunction||!isFunction(iteratorFunction))throw new Error("iter.Iterable: iteratorFunction must be a function.");this.iterator=iteratorFunction},STANDARD_FUNCTION_OPTIONS_DEFAULTS={funcResult:QUICK_RESULT.BOOL,funcParams:null},standardFunction=function(options,callback){options=extend({},STANDARD_FUNCTION_OPTIONS_DEFAULTS,options);var func=options.func,context=options.context,iterable=options.iterable;return throwIfNotQuickOrFunction(func,options.funcArgName,options.methodName),isQuick(func)&&(func=quickToFunction(func,{result:options.funcResult,parameters:options.funcParams})),func=bindContext(func,context),callback(func,iterable)};Iterable.prototype.forEach=function(func,$this){var options={func:func,funcResult:QUICK_RESULT.VOID,context:$this,funcArgName:"func",methodName:"forEach",iterable:this};standardFunction(options,function(func,iterable){for(var it=iterable.iterator(),index=0;it.next();)func(it.current(),index),index+=1})},Iterable.prototype.isEmpty=function(){var it=this.iterator();return Boolean(it.next())===!1};var SOME_DEFAULT_PRED=function(x){return x};Iterable.prototype.some=function(pred,$this){var options={func:void 0===pred?SOME_DEFAULT_PRED:pred,context:$this,funcArgName:"pred",methodName:"some",iterable:this};return standardFunction(options,function(pred,iterable){for(var it=iterable.iterator(),index=0;it.next();){if(pred(it.current(),index))return!0;index+=1}return!1})};var EVERY_DEFAULT_PRED=function(x){return x};Iterable.prototype.every=function(pred,$this){var options={func:void 0===pred?EVERY_DEFAULT_PRED:pred,context:$this,funcArgName:"pred",methodName:"every",iterable:this};return standardFunction(options,function(pred,iterable){for(var it=iterable.iterator(),index=0;it.next();){if(!pred(it.current(),index))return!1;index+=1}return!0})},Iterable.prototype.and=function(){for(var it=this.iterator(),curr=!0;it.next()&&(curr=it.current()););return curr},Iterable.prototype.or=function(){for(var it=this.iterator(),curr=!1;it.next()&&!(curr=it.current()););return curr},Iterable.prototype.count=function(predOpt,$this){var it=null;it=predOpt?this.filter(predOpt,$this).iterator():this.iterator();for(var count=0;it.next();)count+=1;return count},Iterable.prototype.toArray=function(){for(var it=this.iterator(),result=[];it.next();)result.push(it.current());return result};var FilterIterator=function($iterator,$pred){this.$$iterator=$iterator,this.$$pred=$pred,this.$$index=-1};FilterIterator.prototype.next=function(){for(;this.$$iterator.next();)if(this.$$index+=1,this.$$pred(this.$$iterator.current(),this.$$index))return!0;return!1},FilterIterator.prototype.current=function(){return this.$$iterator.current()},Iterable.prototype.filter=function(pred,$this){var options={func:pred,context:$this,funcArgName:"pred",methodName:"filter",iterable:this};return standardFunction(options,function(pred,iterable){return new Iterable(function(){var it=iterable.iterator();return new FilterIterator(it,pred)})})};var MapIterator=function($iterator,$map){this.$$iterator=$iterator,this.$$map=$map,this.$$index=-1,this.$$evaluated=!1};MapIterator.prototype.next=function(){return this.$$iterator.next()?(this.$$cache=void 0,this.$$evaluated=!1,this.$$index+=1,!0):!1},MapIterator.prototype.current=function(){return this.$$evaluated||(this.$$cache=this.$$map(this.$$iterator.current(),this.$$index),this.$$evaluated=!0),this.$$cache},Iterable.prototype.map=function(map,$this){var options={func:map,funcResult:QUICK_RESULT.ANY,context:$this,funcArgName:"map",methodName:"map",iterable:this};return standardFunction(options,function(map,iterable){return new Iterable(function(){var it=iterable.iterator();return new MapIterator(it,map)})})},Iterable.prototype.select=function(){var args=toArray(arguments);if(0===args.length)throw new Error("iter.select: No properties to select passed to select() call.");var mapFunc;if(args.length>1&&isPropertyMultiselector(args))mapFunc=createPropertyMultiselectorFunciton(args);else{if(1!==args.length||!isPropertySelector(args[0]))throw new Error('iter.select: Invalid argument, select() only accept property name(s). To select single property use select("propertyName") syntax, to select multiple properties use select("prop1", "prop2", "prop3") syntax.');mapFunc=createPropertySelectorFunction(args[0])}return this.map(mapFunc)},Iterable.prototype.reduce=function(seed,operation,$this){if(void 0===seed)throw new Error('iter.reduce: missing required argument "seed". Use iter.reduce1() to perform reduce without having to specify seed.');var options={func:operation,funcResult:QUICK_RESULT.ANY,funcParams:["$acc","$","$index"],context:$this,funcArgName:"operation",methodName:"reduce",iterable:this};return standardFunction(options,function(operation,iterable){for(var it=iterable.iterator(),acc=seed,index=0;it.next();)acc=operation(acc,it.current(),index),index+=1;return acc})},Iterable.prototype.reduce1=function(operation,$this){var options={func:operation,funcResult:QUICK_RESULT.ANY,funcParams:["$acc","$","$index"],context:$this,funcArgName:"operation",methodName:"reduce1",iterable:this};return standardFunction(options,function(operation,iterable){var it=iterable.iterator();if(!it.next())throw new Error("iter.reduce1: sequence contains no elements.");for(var acc=it.current(),index=1;it.next();)acc=operation(acc,it.current(),index),index+=1;return acc})};var OP_PLUS=function(acc,x){return acc+Number(x)};Iterable.prototype.sum=function(seedOpt){var seed=Number(seedOpt)||0;return this.reduce(seed,OP_PLUS)};var OP_MUL=function(acc,x){return acc*Number(x)};Iterable.prototype.product=function(seedOpt){var seed=Number(seedOpt)||1;return this.reduce(seed,OP_MUL)},Iterable.prototype.avg=function(){for(var it=this.iterator(),n=0,sum=0;it.next();)n+=1,sum+=Number(it.current());return 0===n?0/0:sum/n};var SkipIterator=function($iterator,$skip){this.$$iterator=$iterator,this.$$skip=$skip};SkipIterator.prototype.next=function(){for(;this.$$iterator.next();){if(0===this.$$skip)return!0;this.$$skip-=1}return!1},SkipIterator.prototype.current=function(){return this.$$iterator.current()},Iterable.prototype.skip=function(count){count=Number(count);var that=this;if(!isFinite(count))throw new Error("iter.skip: invalid argument value.");return count=0>count?0:count,new Iterable(function(){var it=that.iterator();return new SkipIterator(it,count)})};var TakeIterator=function($iterator,$take){this.$$iterator=$iterator,this.$$take=$take};TakeIterator.prototype.next=function(){return 0===this.$$take?!1:this.$$iterator.next()?(this.$$take-=1,!0):!1},TakeIterator.prototype.current=function(){return this.$$iterator.current()},Iterable.prototype.take=function(count){count=Number(count);var that=this;if(!isFinite(count))throw new Error("iter.take: invalid argument value.");return count=0>count?0:count,new Iterable(function(){var it=that.iterator();return new TakeIterator(it,count)})},Iterable.prototype.join=function(separator){var array=this.toArray();return array.join(separator)};var multiComparer=function(){var comparers=toArray(arguments);return function(left,right){for(var i=0;i<comparers.length;i++){var comparisionResult=comparers[i](left,right);if(0!==comparisionResult)return comparisionResult}return 0}},SORT_BY_QUICK_REGEX=/^\$[a-z0-9_]*(\.(([$a-z_][$a-z0-9_]*)|("[^"]*"))( desc)?)?/i,isSortByQuick=function(str){return SORT_BY_QUICK_REGEX.test(str)},parseSortByQuick=function(quick){var quickWithoutDesc=quick,desc=!1;quick.lastIndexOf(" desc")===quick.length-" desc".length&&(quickWithoutDesc=quick.substring(0,quick.length-" desc".length),desc=!0);var dot=quickWithoutDesc.indexOf("."),hasProperty=!0;-1===dot&&(dot=quickWithoutDesc.length,hasProperty=!1);var comparer=quick.substring(0,dot),propertyName=hasProperty?quickWithoutDesc.substring(dot+1):null;return propertyName&&0===propertyName.indexOf('"')&&(propertyName=propertyName.substring(1,propertyName.length-1)),{original:quick,comparer:comparer,propertyName:propertyName,desc:desc}},reverseCompareFunction=function(compareFunction){return function(){return-compareFunction.apply(this,arguments)}},sortByComparers=null,resetComparers=function(){sortByComparers=Object.create(null),sortByComparers.$$=function(l,r){return r>l?-1:l>r?1:0},sortByComparers.$locale$=function(l,r){return String(l||"").localeCompare(r)}};resetComparers();var addSortByComparer=function(comparerName,comparerFunction){sortByComparers[comparerName+"$"]=comparerFunction},getSortByComparer=function(comparerName){return sortByComparers[comparerName+"$"]},createComparerFromQuick=function(quick){quick=parseSortByQuick(quick);var comparerFunction=getSortByComparer(quick.comparer);if(!comparerFunction)throw new Error('iter.sortBy: cannot find comparer: "'+quick.comparer+'"');if(quick.desc&&(comparerFunction=reverseCompareFunction(comparerFunction)),null!==quick.propertyName){var propertySelector=createPropertySelectorFunction(quick.propertyName);return function(l,r){return l=propertySelector(l),r=propertySelector(r),comparerFunction(l,r)}}return comparerFunction};Iterable.prototype.sortBy=function(){var sortCriteria=toArray(arguments);if(0===sortCriteria.length)throw new Error("iter.sortBy: specify at least one sorting criteria.");for(var i=0;i<sortCriteria.length;i+=1)if(throwIfNotQuickOrFunction(sortCriteria[i],"arguments","sortBy"),isString(sortCriteria[i])){if(!isSortByQuick(sortCriteria[i]))throw new Error('iter.sortBy: invalid sort criteria: "'+sortCriteria[i]+'". Quick sort criteria have $comparer.propName or $comparer."prop name" format.');sortCriteria[i]=createComparerFromQuick(sortCriteria[i])}else if(!isFunction(sortCriteria[i]))throw new Error("iter.sortBy: sort criteria must be quick or function.Invalid argument at position: "+i+".");var cmp=multiComparer.apply(null,sortCriteria),that=this;return new Iterable(function(){var data=that.toArray();return data.sort(cmp),new ArrayIterator(data)})};var iter=global.iter=function(obj){if(isArray(obj))return new Iterable(function(){return new ArrayIterator(obj)});if(isObject(obj))return new Iterable(function(){return new ObjectIterator(obj)});if(isFunction(obj))return new Iterable(function(){return new FunctionIterator(obj)});throw new Error("iter: Only arrays, object and functions can be iterated.")};iter.Iterable=Iterable,iter.range=function(){var argsLenght=arguments.length,args=Array.prototype.slice.call(arguments);if(2!==argsLenght&&3!==argsLenght)throw new Error("iter.range: Invalid range arguments. Use range(from, to) or range(from, step, to).");var hasStep=3===argsLenght,from=Number(args[0]),to=Number(hasStep?args[2]:args[1]);if(!isFinite(from))throw new Error("iter.range: from must be a finite number.");if(!isFinite(to))throw new Error("iter.range: to must be a finite number.");var step;if(to>=from){if(step=hasStep?args[1]:1,0>=step)throw new Error("iter.range: step must be a positive number.")}else if(step=hasStep?args[1]:-1,step>=0)throw new Error("iter.range: step must be a negative number.");if(!isFinite(step))throw new Error("iter.range: step must be finite number.");var index=0;return iter(step>=0?function(){var next=from+index*step;return next>=to?void 0:(index+=1,next)}:function(){var next=from+index*step;return to>=next?void 0:(index+=1,next)})};var EMPTY_ITERATOR_FUNCTION=function(){return void 0};iter.empty=function(){return iter(EMPTY_ITERATOR_FUNCTION)},iter.quick=function(parameters,expression,options){var args=toArray(arguments);if(1===args.length&&(parameters=["$"],expression=args[0],options={}),!isArray(parameters))throw new Error('iter.quick: parameters should be passed as array of identifiers e.g. iter.quick(["$"], "$ > 3")');for(var i=0;i<parameters.length;i+=1)if(!isJSIdentifier(parameters[i]))throw new Error('iter.quick: invalid JavaScript parameter name: "'+parameters[i]+'"');if(!isQuick(expression))throw new Error("iter.quick: invalid or missing expression argument");return options=options||{},quickToFunction(expression,{result:QUICK_RESULT.ANY,parameters:parameters})},iter.sortBy=Object.create(null),iter.sortBy.addComparer=function(comparerName,comparerFunction){if(!comparerName)throw new Error("iter.sortBy.addComparer: comparer name cannot be empty.");if(!isString(comparerName))throw new TypeError("iter.sort.addComparer: comparer name must be a string.");if(0!==comparerName.indexOf("$"))throw new Error("iter.sortBy.addComparer: comparer name must start with $.");if(!comparerFunction)throw new Error("iter.sort.addComparer: missing argument - comparerFunction.");if(!isFunction(comparerFunction))throw new TypeError("iter.sort.addComparer: Comparer function must be a function.");addSortByComparer(comparerName,comparerFunction)},iter.sortBy.resetComparers=function(){resetComparers()}}("undefined"==typeof window?global:window);